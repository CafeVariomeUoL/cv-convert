<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes, GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# OPTIONS_HADDOCK ignore-exports #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">{-|
Module      : Runtime
Description : Main entrypoint to cv-convert
Copyright   : (c) Samuel Balco, 2020
License     : MIT
Maintainer  : sam@definitelynotspam.email

The runtime module exports the main functionality of the cv-convert tool.
-}</span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Runtime</span><span class="hs-special">(</span><span class="annot"><a href="DB.Types.html#SourceID"><span class="hs-identifier">SourceID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutputOpt"><span class="hs-identifier">DataOutputOpt</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOpt"><span class="hs-identifier">ErrorOpt</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier">TerminateOnError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#FileType"><span class="hs-identifier">FileType</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#SheetName"><span class="hs-identifier">SheetName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#LibFunctions"><span class="hs-identifier">LibFunctions</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#Settings"><span class="hs-identifier">Settings</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.html#loadLibrary"><span class="hs-identifier">loadLibrary</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.Types.html#fromSpecifiedFileType"><span class="hs-identifier">fromSpecifiedFileType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Runtime.html#processFile"><span class="hs-identifier">processFile</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Schema.html#compileSchema"><span class="hs-identifier">compileSchema</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Main.Utf8</span></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">withUtf8</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">openFile</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IOMode</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">hClose</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Value</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">decode</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toJSON</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Aeson.Encode.Pretty</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">encodePretty</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BSL</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder</span></span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadThrow</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadMask</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">try</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">catch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">bracket</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadReader</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(^.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Lens.Combinators</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FoldableWithIndex</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ifoldlM</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FilePath.Posix</span></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">takeFileName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;.&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.String.Conv</span></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toS</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">doesFileExist</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Database.MySQL.Base</span></span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MySQL</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Crypto.Hash.SHA256</span></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hashlazy</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.Wreq</span></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">get</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">responseBody</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Runtime.Types.html"><span class="hs-identifier">Runtime.Types</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Runtime.Error.html"><span class="hs-identifier">Runtime.Error</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Quickjs</span></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">JSValue</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">JSContextPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">eval_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">withJSValue</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Quickjs.Error</span></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SomeJSRuntimeException</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Schema.html"><span class="hs-identifier">Schema</span></a></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="Schema.html#compileSchema"><span class="hs-identifier">compileSchema</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Schema.html#validate"><span class="hs-identifier">validate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ValidatorFailure</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Parse.Xlsx.html"><span class="hs-identifier">Parse.Xlsx</span></a></span><span>                   </span><span class="hs-special">(</span><span class="annot"><a href="Parse.Xlsx.html#readXlsxFile"><span class="hs-identifier">readXlsxFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Parse.Csv.html"><span class="hs-identifier">Parse.Csv</span></a></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Parse.Csv.html#readCsvFile"><span class="hs-identifier">readCsvFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="DB.html"><span class="hs-identifier">DB</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="DB.Postgres.html"><span class="hs-identifier">DB.Postgres</span></a></span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Postgres</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="DB.MySQL.html"><span class="hs-identifier">DB.MySQL</span></a></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MySQL</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="JSON.Utils.html"><span class="hs-identifier">JSON.Utils</span></a></span><span>                   </span><span class="hs-special">(</span><span class="annot"><a href="JSON.Utils.html#createAllPathsWithValues"><span class="hs-identifier">createAllPathsWithValues</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="JSON.Utils.html#flattenToEAV"><span class="hs-identifier">flattenToEAV</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="JSON.Utils.html#getSubjectID"><span class="hs-identifier">getSubjectID</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">{-|
The 'loadLibrary' function takse a 'LibFunctions' parameter, which either contains an inline JS script or points
to an external script via URL. The library functions must be stored in a specific way, namely the library file must
be of the form

&gt;Lib.fun1 = (a,b) =&gt; {...},
&gt;Lib.fun2 = ...
-}</span><span>
</span><span id="line-66"></span><span id="local-6989586621679599157"><span class="annot"><a href="Runtime.html#loadLibrary"><span class="hs-identifier hs-type">loadLibrary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679599157"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679599157"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679599157"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#LibFunctions"><span class="hs-identifier hs-type">LibFunctions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599157"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-67"></span><span id="loadLibrary"><span class="annot"><span class="annottext">loadLibrary :: LibFunctions -&gt; m ()
</span><a href="Runtime.html#loadLibrary"><span class="hs-identifier hs-var hs-var">loadLibrary</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Runtime.Types.html#Inline"><span class="hs-identifier hs-type">Inline</span></a></span><span> </span><span id="local-6989586621679599155"><span class="annot"><span class="annottext">script :: ByteString
</span><a href="#local-6989586621679599155"><span class="hs-identifier hs-var">script</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m ()
forall (m :: * -&gt; *).
(MonadThrow m, MonadReader JSContextPtr m, MonadIO m) =&gt;
ByteString -&gt; m ()
</span><span class="hs-identifier hs-var">eval_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Lib = {};\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599155"><span class="hs-identifier hs-var">script</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="annot"><a href="Runtime.html#loadLibrary"><span class="hs-identifier hs-var">loadLibrary</span></a></span><span> </span><span id="local-6989586621679599153"><span id="local-6989586621679599154"><span class="annot"><a href="Runtime.Types.html#External"><span class="hs-identifier hs-type">External</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679599149"><span class="annot"><span class="annottext">libPath :: FilePath
</span><a href="#local-6989586621679599149"><span class="hs-identifier hs-var hs-var">libPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; FilePath
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599153"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;js&quot;</span></span><span>
</span><span id="line-70"></span><span>  </span><span id="local-6989586621679599148"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599148"><span class="hs-identifier hs-var">lib</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; m ByteString
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; m ByteString) -&gt; IO ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Bool
</span><span class="hs-identifier hs-var">doesFileExist</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599149"><span class="hs-identifier hs-var">libPath</span></a></span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; (Bool -&gt; IO ByteString) -&gt; IO ByteString
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ByteString) -&gt; IO ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) r. (MonadIO m, MonadMask m) =&gt; m r -&gt; m r
</span><span class="hs-identifier hs-var">withUtf8</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ByteString) -&gt; IO ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BS.readFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599149"><span class="hs-identifier hs-var">libPath</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-73"></span><span>      </span><span id="local-6989586621679599146"><span class="annot"><span class="annottext">Response ByteString
</span><a href="#local-6989586621679599146"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Response ByteString) -&gt; IO (Response ByteString)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Response ByteString) -&gt; IO (Response ByteString))
-&gt; IO (Response ByteString) -&gt; IO (Response ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Response ByteString)
</span><span class="hs-identifier hs-var">get</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO (Response ByteString))
-&gt; FilePath -&gt; IO (Response ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FilePath
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599154"><span class="hs-identifier hs-var">url</span></a></span><span>
</span><span id="line-74"></span><span>      </span><span class="hs-comment">-- get the contents (as a lazy ByteString)</span><span>
</span><span id="line-75"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679599145"><span class="annot"><span class="annottext">contents :: ByteString
</span><a href="#local-6989586621679599145"><span class="hs-identifier hs-var hs-var">contents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response ByteString
</span><a href="#local-6989586621679599146"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Response ByteString
-&gt; Getting ByteString (Response ByteString) ByteString
-&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Response ByteString) ByteString
forall body0 body1.
Lens (Response body0) (Response body1) body0 body1
</span><span class="hs-identifier hs-var">responseBody</span></span><span>
</span><span id="line-76"></span><span>          </span><span id="local-6989586621679599144"><span class="annot"><span class="annottext">contents_hash :: ByteString
</span><a href="#local-6989586621679599144"><span class="hs-identifier hs-var hs-var">contents_hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.toLazyByteString</span></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; ByteString) -&gt; Builder -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><span class="hs-identifier hs-var">BS.byteStringHex</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Builder) -&gt; ByteString -&gt; Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">hashlazy</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599145"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599144"><span class="hs-identifier hs-var">contents_hash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599153"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMismatch -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(HashMismatch -&gt; IO ()) -&gt; HashMismatch -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMismatch :: Text -&gt; Text -&gt; Text -&gt; HashMismatch
</span><a href="Runtime.Error.html#HashMismatch"><span class="hs-identifier hs-type hs-type">HashMismatch</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-79"></span><span>          </span><span class="annot"><span class="annottext">url :: Text
</span><a href="Runtime.Error.html#url"><span class="hs-identifier hs-var">url</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599154"><span class="hs-identifier hs-var">url</span></a></span><span>
</span><span id="line-80"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">expected_hash :: Text
</span><a href="Runtime.Error.html#expected_hash"><span class="hs-identifier hs-var">expected_hash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599153"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">found_hash :: Text
</span><a href="Runtime.Error.html#found_hash"><span class="hs-identifier hs-var">found_hash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599144"><span class="hs-identifier hs-var">contents_hash</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BSL.writeFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599149"><span class="hs-identifier hs-var">libPath</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599145"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ByteString) -&gt; ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599145"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m ()
forall (m :: * -&gt; *).
(MonadThrow m, MonadReader JSContextPtr m, MonadIO m) =&gt;
ByteString -&gt; m ()
</span><span class="hs-identifier hs-var">eval_</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m ()) -&gt; ByteString -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Lib = {};\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599148"><span class="hs-identifier hs-var">lib</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">{-|
This function runs the converter function on the row and header input data, 
then runs the validator(to check that the JSON 'Value' that was produced validates
agains the JSON schema).

If the output is valid, the data is either stored in a database or a JSON text file.
When inserting into database, the output is stored in two different tables:

  - The 'insertJSONBOverwriteOnConflict' function stores the data as Postgres JSONB in the 
    @eavs_jsonb_attributes_values@ table
  - 'flattenToEAV' is used to generate flattened EAV triples form the given JOSn object, which are
    then stored in the @eavs@ table via 'insertEAV'

Finally, we return result of running 'createAllPathsWithValues' on the JSON output data.
-}</span><span>
</span><span id="line-106"></span><span id="local-6989586621679599256"><span id="local-6989586621679599257"><span class="annot"><a href="Runtime.html#convertRow"><span class="hs-identifier hs-type">convertRow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679599257"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679599257"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679599257"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-107"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ Row index/counter</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-comment">-- ^ Row data as JSON</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599256"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-comment">-- ^ Row header</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599256"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599257"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Coverter function taking the row and header returning a JSON 'Value'</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ValidatorFailure</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Validator function, used to check that the output of the converter function</span><span>
</span><span id="line-112"></span><span>                                   </span><span class="hs-comment">-- conforms to the JSON schema, specified in 'jsonSchema'</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutput"><span class="hs-identifier hs-type">DataOutput</span></a></span><span> </span><span class="hs-comment">-- ^ Either a Database connection or a file handle, </span><span>
</span><span id="line-114"></span><span>                </span><span class="hs-comment">-- depending on where we output data</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-type">ErrorOutput</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier hs-type">TerminateOnError</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599257"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ returns a map from JSON 'Value's to a set of 'Value's, </span><span>
</span><span id="line-118"></span><span>                                                    </span><span class="hs-comment">-- by calling 'createAllPathsWithValues' on the converter function output</span></span></span><span>
</span><span id="line-119"></span><span id="convertRow"><span class="annot"><span class="annottext">convertRow :: Int
-&gt; Value
-&gt; header
-&gt; (JSValue -&gt; header -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#convertRow"><span class="hs-identifier hs-var hs-var">convertRow</span></a></span></span><span> </span><span id="local-6989586621679599133"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679599133"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679599132"><span class="annot"><span class="annottext">rowJSON :: Value
</span><a href="#local-6989586621679599132"><span class="hs-identifier hs-var">rowJSON</span></a></span></span><span> </span><span id="local-6989586621679599131"><span class="annot"><span class="annottext">header :: header
</span><a href="#local-6989586621679599131"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679599130"><span class="annot"><span class="annottext">rowFun :: JSValue -&gt; header -&gt; m Value
</span><a href="#local-6989586621679599130"><span class="hs-identifier hs-var">rowFun</span></a></span></span><span> </span><span id="local-6989586621679599129"><span class="annot"><span class="annottext">validator :: Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599129"><span class="hs-identifier hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621679599128"><span class="annot"><span class="annottext">outputHandle :: DataOutput
</span><a href="#local-6989586621679599128"><span class="hs-identifier hs-var">outputHandle</span></a></span></span><span> </span><span id="local-6989586621679599127"><span class="annot"><span class="annottext">onError :: ErrorOutput
</span><a href="#local-6989586621679599127"><span class="hs-identifier hs-var">onError</span></a></span></span><span> </span><span id="local-6989586621679599126"><span class="annot"><span class="annottext">terminateOnError :: TerminateOnError
</span><a href="#local-6989586621679599126"><span class="hs-identifier hs-var">terminateOnError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">m Value -&gt; m (Either SomeRuntimeException Value)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; (JSValue -&gt; m Value) -&gt; m Value
forall (m :: * -&gt; *) a b.
(MonadMask m, MonadReader JSContextPtr m, MonadIO m, ToJSON a) =&gt;
a -&gt; (JSValue -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withJSValue</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599132"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="annottext">((JSValue -&gt; m Value) -&gt; m Value)
-&gt; (JSValue -&gt; m Value) -&gt; m Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599125"><span class="annot"><span class="annottext">row :: JSValue
</span><a href="#local-6989586621679599125"><span class="hs-identifier hs-var">row</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; header -&gt; m Value
</span><a href="#local-6989586621679599130"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue
</span><a href="#local-6989586621679599125"><span class="hs-identifier hs-var">row</span></a></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679599131"><span class="hs-identifier hs-var">header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m Value -&gt; (SomeJSRuntimeException -&gt; m Value) -&gt; m Value
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679599124"><span class="annot"><span class="annottext">SomeJSRuntimeException
</span><a href="#local-6989586621679599124"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">SomeJSRuntimeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JSRuntimeError -&gt; m Value
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(JSRuntimeError -&gt; m Value) -&gt; JSRuntimeError -&gt; m Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; JSRuntimeError
</span><a href="Runtime.Error.html#JSRuntimeError"><span class="hs-identifier hs-var">JSRuntimeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeJSRuntimeException -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeJSRuntimeException
</span><a href="#local-6989586621679599124"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either SomeRuntimeException Value)
-&gt; (Either SomeRuntimeException Value
    -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">-- Below, we catch in two stages, to get better errors. Notice the second catch in </span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">-- the Right branch has the additional parameter res, which is added to the error</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- output for easier debugging.</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679599121"><span class="annot"><span class="annottext">SomeRuntimeException
</span><a href="#local-6989586621679599121"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">::</span><span class="annot"><a href="Runtime.Error.html#SomeRuntimeException"><span class="hs-identifier hs-type">SomeRuntimeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TerminateOnError
-&gt; ErrorOutput
-&gt; Int
-&gt; SomeRuntimeException
-&gt; Value
-&gt; Value
-&gt; m ()
forall (m :: * -&gt; *).
(MonadThrow m, MonadIO m) =&gt;
TerminateOnError
-&gt; ErrorOutput
-&gt; Int
-&gt; SomeRuntimeException
-&gt; Value
-&gt; Value
-&gt; m ()
</span><a href="Runtime.Error.html#handleError"><span class="hs-identifier hs-var">handleError</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679599126"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679599127"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599133"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SomeRuntimeException
</span><a href="#local-6989586621679599121"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599132"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; m (HashMap Value (HashSet Value))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Array</span></span><span> </span><span id="local-6989586621679599117"><span class="annot"><span class="annottext">resMultiple :: Array
</span><a href="#local-6989586621679599117"><span class="hs-identifier hs-var">resMultiple</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-comment">-- if rowFun returns an array of records, we process each one and merge the resulting</span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-comment">-- jsonAttrVals from each run.</span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="annottext">(Int
 -&gt; HashMap Value (HashSet Value)
 -&gt; Value
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; HashMap Value (HashSet Value)
-&gt; Array
-&gt; m (HashMap Value (HashSet Value))
forall i (f :: * -&gt; *) (m :: * -&gt; *) b a.
(FoldableWithIndex i f, Monad m) =&gt;
(i -&gt; b -&gt; a -&gt; m b) -&gt; b -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">ifoldlM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679599116"><span class="annot"><span class="annottext">j :: Int
</span><a href="#local-6989586621679599116"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span id="local-6989586621679599115"><span class="annot"><span class="annottext">jsonAttrValsAcc :: HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599115"><span class="hs-identifier hs-var">jsonAttrValsAcc</span></a></span></span><span> </span><span id="local-6989586621679599114"><span class="annot"><span class="annottext">res :: Value
</span><a href="#local-6989586621679599114"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>          </span><span id="local-6989586621679599113"><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599113"><span class="hs-identifier hs-var">jsonAttrVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Value -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679599112"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599116"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599114"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-131"></span><span>          </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(HashMap Value (HashSet Value)
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; HashMap Value (HashSet Value)
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HashSet Value -&gt; HashSet Value -&gt; HashSet Value)
-&gt; HashMap Value (HashSet Value)
-&gt; HashMap Value (HashSet Value)
-&gt; HashMap Value (HashSet Value)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.unionWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet Value -&gt; HashSet Value -&gt; HashSet Value
forall a. (Eq a, Hashable a) =&gt; HashSet a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.union</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599113"><span class="hs-identifier hs-var">jsonAttrVals</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599115"><span class="hs-identifier hs-var">jsonAttrValsAcc</span></a></span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679599117"><span class="hs-identifier hs-var">resMultiple</span></a></span><span> </span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679599109"><span class="annot"><span class="annottext">res :: Value
</span><a href="#local-6989586621679599109"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Value -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679599112"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">0</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599109"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621679599112"><span class="annot"><span class="annottext">process :: Int -&gt; Value -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679599112"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span id="local-6989586621679599108"><span class="annot"><span class="annottext">j :: Int
</span><a href="#local-6989586621679599108"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span id="local-6989586621679599107"><span class="annot"><span class="annottext">res :: Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><span class="annottext">(Value -&gt; [ValidatorFailure]) -&gt; Value -&gt; m ()
forall (m :: * -&gt; *).
MonadThrow m =&gt;
(Value -&gt; [ValidatorFailure]) -&gt; Value -&gt; m ()
</span><a href="Schema.html#validate"><span class="hs-identifier hs-var">validate</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599129"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-137"></span><span>      </span><span id="local-6989586621679599106"><span class="annot"><span class="annottext">SubjectID
</span><a href="#local-6989586621679599106"><span class="hs-identifier hs-var">subjectID</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Value -&gt; m SubjectID
forall (m :: * -&gt; *). MonadThrow m =&gt; Value -&gt; m SubjectID
</span><a href="JSON.Utils.html#getSubjectID"><span class="hs-identifier hs-var">getSubjectID</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="annottext">IO (HashMap Value (HashSet Value))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (HashMap Value (HashSet Value))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; IO (HashMap Value (HashSet Value))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679599128"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><a href="Runtime.Types.html#DBOutput"><span class="hs-identifier hs-type">DBOutput</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679599104"><span id="local-6989586621679599103"><span class="annot"><span class="annottext">con_t
</span><a href="#local-6989586621679599103"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679599104"><span class="hs-identifier hs-type">con_t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679599102"><span class="annot"><span class="annottext">sourceID :: SourceID
</span><a href="#local-6989586621679599102"><span class="hs-identifier hs-var">sourceID</span></a></span></span><span> </span><span id="local-6989586621679599101"><span class="annot"><span class="annottext">fileID :: FileID
</span><a href="#local-6989586621679599101"><span class="hs-identifier hs-var">fileID</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>          </span><span class="hs-comment">-- insert record into the JSONB table</span><span>
</span><span id="line-141"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DBConn con_t =&gt; DBType con_t
forall con_ty. DBConn con_ty =&gt; DBType con_ty
</span><a href="DB.html#dbType"><span class="hs-identifier hs-var">dbType</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679599104"><span class="hs-identifier hs-type">con_t</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-142"></span><span>            </span><span class="annot"><a href="DB.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SourceID -&gt; FileID -&gt; SubjectID -&gt; Value -&gt; con_t -&gt; IO ()
forall conn.
IConnection conn =&gt;
SourceID -&gt; FileID -&gt; SubjectID -&gt; Value -&gt; conn -&gt; IO ()
</span><a href="DB.Postgres.html#insertJSONBOverwriteOnConflict"><span class="hs-identifier hs-var">Postgres.insertJSONBOverwriteOnConflict</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679599102"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="annot"><span class="annottext">FileID
</span><a href="#local-6989586621679599101"><span class="hs-identifier hs-var">fileID</span></a></span><span> </span><span class="annot"><span class="annottext">SubjectID
</span><a href="#local-6989586621679599106"><span class="hs-identifier hs-var">subjectID</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">con_t
</span><a href="#local-6989586621679599103"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-143"></span><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>          </span><span class="hs-comment">-- flatten record into EAV and insert into the EAV table</span><span>
</span><span id="line-145"></span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span id="local-6989586621679599097"><span class="annot"><span class="annottext">eav :: [(UUID, Text, Text)]
</span><a href="#local-6989586621679599097"><span class="hs-identifier hs-var">eav</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Value -&gt; IO (UUID, [(UUID, Text, Text)])
forall (m :: * -&gt; *).
MonadIO m =&gt;
Value -&gt; m (UUID, [(UUID, Text, Text)])
</span><a href="JSON.Utils.html#flattenToEAV"><span class="hs-identifier hs-var">flattenToEAV</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-146"></span><span>          </span><span class="annot"><span class="annottext">[(UUID, Text, Text)] -&gt; ((UUID, Text, Text) -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(UUID, Text, Text)]
</span><a href="#local-6989586621679599097"><span class="hs-identifier hs-var">eav</span></a></span><span> </span><span class="annot"><span class="annottext">(((UUID, Text, Text) -&gt; IO ()) -&gt; IO ())
-&gt; ((UUID, Text, Text) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679599096"><span class="annot"><span class="annottext">uuid :: UUID
</span><a href="#local-6989586621679599096"><span class="hs-identifier hs-var">uuid</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679599095"><span class="annot"><span class="annottext">attr :: Text
</span><a href="#local-6989586621679599095"><span class="hs-identifier hs-var">attr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679599094"><span class="annot"><span class="annottext">val :: Text
</span><a href="#local-6989586621679599094"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UUID
-&gt; SourceID
-&gt; FileID
-&gt; SubjectID
-&gt; Text
-&gt; Text
-&gt; con_t
-&gt; IO ()
forall con.
DBConn con =&gt;
UUID
-&gt; SourceID -&gt; FileID -&gt; SubjectID -&gt; Text -&gt; Text -&gt; con -&gt; IO ()
</span><a href="DB.html#insertEAV"><span class="hs-identifier hs-var">insertEAV</span></a></span><span> </span><span class="annot"><span class="annottext">UUID
</span><a href="#local-6989586621679599096"><span class="hs-identifier hs-var">uuid</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679599102"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="annot"><span class="annottext">FileID
</span><a href="#local-6989586621679599101"><span class="hs-identifier hs-var">fileID</span></a></span><span> </span><span class="annot"><span class="annottext">SubjectID
</span><a href="#local-6989586621679599106"><span class="hs-identifier hs-var">subjectID</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599095"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599094"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">con_t
</span><a href="#local-6989586621679599103"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-147"></span><span>          </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; IO (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(HashMap Value (HashSet Value)
 -&gt; IO (HashMap Value (HashSet Value)))
-&gt; HashMap Value (HashSet Value)
-&gt; IO (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; HashMap Value (HashSet Value)
</span><a href="JSON.Utils.html#createAllPathsWithValues"><span class="hs-identifier hs-var">createAllPathsWithValues</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><a href="Runtime.Types.html#JSONFileOutput"><span class="hs-identifier hs-type">JSONFileOutput</span></a></span><span> </span><span id="local-6989586621679599091"><span class="annot"><span class="annottext">outputFileHandle :: Handle
</span><a href="#local-6989586621679599091"><span class="hs-identifier hs-var">outputFileHandle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599133"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599108"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BSL.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679599091"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot; , &quot;</span></span><span>
</span><span id="line-150"></span><span>          </span><span class="annot"><span class="annottext">Handle -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BSL.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679599091"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ()) -&gt; ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">encodePretty</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-151"></span><span>          </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; IO (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><a href="Runtime.Types.html#ConsoleOutput"><span class="hs-identifier hs-type">ConsoleOutput</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; FilePath
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; FilePath) -&gt; ByteString -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">encodePretty</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-154"></span><span>          </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; IO (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><a href="Runtime.Types.html#SQLFileOutput"><span class="hs-identifier hs-type">SQLFileOutput</span></a></span><span> </span><span id="local-6989586621679599084"><span class="annot"><span class="annottext">sourceID :: SourceID
</span><a href="#local-6989586621679599084"><span class="hs-identifier hs-var">sourceID</span></a></span></span><span> </span><span id="local-6989586621679599083"><span class="annot"><span class="annottext">outputFileHandle :: Handle
</span><a href="#local-6989586621679599083"><span class="hs-identifier hs-var">outputFileHandle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span id="local-6989586621679599082"><span class="annot"><span class="annottext">eav :: [(UUID, Text, Text)]
</span><a href="#local-6989586621679599082"><span class="hs-identifier hs-var">eav</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Value -&gt; IO (UUID, [(UUID, Text, Text)])
forall (m :: * -&gt; *).
MonadIO m =&gt;
Value -&gt; m (UUID, [(UUID, Text, Text)])
</span><a href="JSON.Utils.html#flattenToEAV"><span class="hs-identifier hs-var">flattenToEAV</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-157"></span><span>          </span><span class="annot"><span class="annottext">[(UUID, Text, Text)] -&gt; ((UUID, Text, Text) -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(UUID, Text, Text)]
</span><a href="#local-6989586621679599082"><span class="hs-identifier hs-var">eav</span></a></span><span> </span><span class="annot"><span class="annottext">(((UUID, Text, Text) -&gt; IO ()) -&gt; IO ())
-&gt; ((UUID, Text, Text) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679599081"><span class="annot"><span class="annottext">uuid :: UUID
</span><a href="#local-6989586621679599081"><span class="hs-identifier hs-var">uuid</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679599080"><span class="annot"><span class="annottext">attr :: Text
</span><a href="#local-6989586621679599080"><span class="hs-identifier hs-var">attr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679599079"><span class="annot"><span class="annottext">val :: Text
</span><a href="#local-6989586621679599079"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BSL.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679599083"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ()) -&gt; ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
forall a b. StringConv a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">toS</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Query -&gt; ByteString
</span><span class="hs-identifier hs-var hs-var">fromQuery</span></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; ByteString) -&gt; Query -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UUID -&gt; SourceID -&gt; FileID -&gt; SubjectID -&gt; Text -&gt; Text -&gt; Query
</span><a href="DB.MySQL.html#insertEAVPrepareQuery"><span class="hs-identifier hs-var">MySQL.insertEAVPrepareQuery</span></a></span><span> </span><span class="annot"><span class="annottext">UUID
</span><a href="#local-6989586621679599081"><span class="hs-identifier hs-var">uuid</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679599084"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FileID
</span><a href="DB.Types.html#FileID"><span class="hs-identifier hs-var">FileID</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubjectID
</span><a href="#local-6989586621679599106"><span class="hs-identifier hs-var">subjectID</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599080"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599079"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;;\n&quot;</span></span><span>
</span><span id="line-158"></span><span>          </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; IO (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">m (HashMap Value (HashSet Value))
-&gt; (SomeRuntimeException -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679599075"><span class="annot"><span class="annottext">SomeRuntimeException
</span><a href="#local-6989586621679599075"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">::</span><span class="annot"><a href="Runtime.Error.html#SomeRuntimeException"><span class="hs-identifier hs-type">SomeRuntimeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TerminateOnError
-&gt; ErrorOutput
-&gt; Int
-&gt; SomeRuntimeException
-&gt; Value
-&gt; Value
-&gt; m ()
forall (m :: * -&gt; *).
(MonadThrow m, MonadIO m) =&gt;
TerminateOnError
-&gt; ErrorOutput
-&gt; Int
-&gt; SomeRuntimeException
-&gt; Value
-&gt; Value
-&gt; m ()
</span><a href="Runtime.Error.html#handleError"><span class="hs-identifier hs-var">handleError</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679599126"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679599127"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599133"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SomeRuntimeException
</span><a href="#local-6989586621679599075"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599132"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599107"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; m (HashMap Value (HashSet Value))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">{-|
Helper function which loops over the rows of the given input, 
collecting and merging all the resulting maps (generated inside 'convertRow' via 'createAllPathsWithValues') 
-}</span><span>
</span><span id="line-165"></span><span id="local-6989586621679599262"><span id="local-6989586621679599263"><span id="local-6989586621679599264"><span class="annot"><a href="Runtime.html#processRow"><span class="hs-identifier hs-type">processRow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FoldableWithIndex</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="#local-6989586621679599264"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679599263"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span>
</span><span id="line-166"></span><span>       </span><span class="annot"><a href="#local-6989586621679599264"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679599262"><span class="hs-identifier hs-type">row</span></a></span><span> </span><span class="hs-comment">-- ^ Any list like data structure containing rows we can loop over with an index</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599262"><span class="hs-identifier hs-type">row</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599263"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Function that consumes the row together with it's index</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599263"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-169"></span><span id="processRow"><span class="annot"><span class="annottext">processRow :: f row
-&gt; (Int -&gt; row -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processRow"><span class="hs-identifier hs-var hs-var">processRow</span></a></span></span><span> </span><span id="local-6989586621679599073"><span class="annot"><span class="annottext">input :: f row
</span><a href="#local-6989586621679599073"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621679599072"><span class="annot"><span class="annottext">m :: Int -&gt; row -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679599072"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int
 -&gt; HashMap Value (HashSet Value)
 -&gt; row
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; HashMap Value (HashSet Value)
-&gt; f row
-&gt; m (HashMap Value (HashSet Value))
forall i (f :: * -&gt; *) (m :: * -&gt; *) b a.
(FoldableWithIndex i f, Monad m) =&gt;
(i -&gt; b -&gt; a -&gt; m b) -&gt; b -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">ifoldlM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679599071"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679599071"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679599070"><span class="annot"><span class="annottext">jsonAttrValsAcc :: HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599070"><span class="hs-identifier hs-var">jsonAttrValsAcc</span></a></span></span><span> </span><span id="local-6989586621679599069"><span class="annot"><span class="annottext">l :: row
</span><a href="#local-6989586621679599069"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679599068"><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599068"><span class="hs-identifier hs-var">jsonAttrVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; row -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679599072"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599071"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">row
</span><a href="#local-6989586621679599069"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(HashMap Value (HashSet Value)
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; HashMap Value (HashSet Value)
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HashSet Value -&gt; HashSet Value -&gt; HashSet Value)
-&gt; HashMap Value (HashSet Value)
-&gt; HashMap Value (HashSet Value)
-&gt; HashMap Value (HashSet Value)
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; HashMap k v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.unionWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet Value -&gt; HashSet Value -&gt; HashSet Value
forall a. (Eq a, Hashable a) =&gt; HashSet a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.union</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599068"><span class="hs-identifier hs-var">jsonAttrVals</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679599070"><span class="hs-identifier hs-var">jsonAttrValsAcc</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span> </span><span class="annot"><span class="annottext">f row
</span><a href="#local-6989586621679599073"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span id="local-6989586621679599196"><span class="annot"><a href="Runtime.html#processTxtFile"><span class="hs-identifier hs-type">processTxtFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679599196"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679599196"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679599196"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-176"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599196"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ValidatorFailure</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutput"><span class="hs-identifier hs-type">DataOutput</span></a></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-type">ErrorOutput</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier hs-type">TerminateOnError</span></a></span><span> </span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599196"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-184"></span><span id="processTxtFile"><span class="annot"><span class="annottext">processTxtFile :: (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; Int
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processTxtFile"><span class="hs-identifier hs-var hs-var">processTxtFile</span></a></span></span><span> </span><span id="local-6989586621679599066"><span class="annot"><span class="annottext">rowFun :: JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599066"><span class="hs-identifier hs-var">rowFun</span></a></span></span><span> </span><span id="local-6989586621679599065"><span class="annot"><span class="annottext">validator :: Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599065"><span class="hs-identifier hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621679599064"><span class="annot"><span class="annottext">fName :: FilePath
</span><a href="#local-6989586621679599064"><span class="hs-identifier hs-var">fName</span></a></span></span><span> </span><span id="local-6989586621679599063"><span class="annot"><span class="annottext">outputHandle :: DataOutput
</span><a href="#local-6989586621679599063"><span class="hs-identifier hs-var">outputHandle</span></a></span></span><span> </span><span id="local-6989586621679599062"><span class="annot"><span class="annottext">onError :: ErrorOutput
</span><a href="#local-6989586621679599062"><span class="hs-identifier hs-var">onError</span></a></span></span><span> </span><span id="local-6989586621679599061"><span class="annot"><span class="annottext">terminateOnError :: TerminateOnError
</span><a href="#local-6989586621679599061"><span class="hs-identifier hs-var">terminateOnError</span></a></span></span><span> </span><span id="local-6989586621679599060"><span class="annot"><span class="annottext">startFromLine :: Int
</span><a href="#local-6989586621679599060"><span class="hs-identifier hs-var">startFromLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>  </span><span id="local-6989586621679599059"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679599059"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Handle -&gt; m Handle
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Handle -&gt; m Handle) -&gt; IO Handle -&gt; m Handle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599064"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">ReadMode</span></span><span>
</span><span id="line-186"></span><span>  </span><span id="local-6989586621679599057"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599057"><span class="hs-identifier hs-var">txt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Text -&gt; m Text
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Text -&gt; m Text) -&gt; IO Text -&gt; m Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO Text
</span><span class="hs-identifier hs-var">Text.hGetContents</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679599059"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><span class="annottext">[(Text, Text)]
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b.
(MonadMask m, MonadReader JSContextPtr m, MonadIO m, ToJSON a) =&gt;
a -&gt; (JSValue -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withJSValue</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;h&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;data&quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text.Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text.Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((JSValue -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599055"><span class="annot"><span class="annottext">header :: JSValue
</span><a href="#local-6989586621679599055"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><span class="annottext">[Text]
-&gt; (Int -&gt; Text -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (f :: * -&gt; *) (m :: * -&gt; *) row.
(FoldableWithIndex Int f, MonadThrow m) =&gt;
f row
-&gt; (Int -&gt; row -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processRow"><span class="hs-identifier hs-var">processRow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; [Text]
</span><span class="hs-identifier hs-var">Text.lines</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599057"><span class="hs-identifier hs-var">txt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Text -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (Int -&gt; Text -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599053"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679599053"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679599052"><span class="annot"><span class="annottext">l :: Text
</span><a href="#local-6989586621679599052"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599053"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599060"><span class="hs-identifier hs-var">startFromLine</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679599050"><span class="annot"><span class="annottext">rowJSON :: Value
</span><a href="#local-6989586621679599050"><span class="hs-identifier hs-var hs-var">rowJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Object</span></span><span> </span><span class="annot"><span class="annottext">(Object -&gt; Value) -&gt; Object -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Text, Value)] -&gt; Object
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599053"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;data&quot;</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599052"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">in</span><span> </span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; Value
-&gt; JSValue
-&gt; (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) header.
(MonadReader JSContextPtr m, MonadMask m, MonadIO m) =&gt;
Int
-&gt; Value
-&gt; header
-&gt; (JSValue -&gt; header -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#convertRow"><span class="hs-identifier hs-var">convertRow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599053"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599050"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue
</span><a href="#local-6989586621679599055"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599066"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599065"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679599063"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679599062"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679599061"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span id="local-6989586621679599195"><span class="annot"><a href="Runtime.html#processXlsxFile"><span class="hs-identifier hs-type">processXlsxFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679599195"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679599195"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679599195"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-196"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599195"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ValidatorFailure</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutput"><span class="hs-identifier hs-type">DataOutput</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-type">ErrorOutput</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier hs-type">TerminateOnError</span></a></span><span> </span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Runtime.Types.html#SheetName"><span class="hs-identifier hs-type">SheetName</span></a></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599195"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-204"></span><span id="processXlsxFile"><span class="annot"><span class="annottext">processXlsxFile :: (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; Maybe SheetName
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processXlsxFile"><span class="hs-identifier hs-var hs-var">processXlsxFile</span></a></span></span><span> </span><span id="local-6989586621679599046"><span class="annot"><span class="annottext">rowFun :: JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599046"><span class="hs-identifier hs-var">rowFun</span></a></span></span><span> </span><span id="local-6989586621679599045"><span class="annot"><span class="annottext">validator :: Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599045"><span class="hs-identifier hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621679599044"><span class="annot"><span class="annottext">fName :: FilePath
</span><a href="#local-6989586621679599044"><span class="hs-identifier hs-var">fName</span></a></span></span><span> </span><span id="local-6989586621679599043"><span class="annot"><span class="annottext">outputHandle :: DataOutput
</span><a href="#local-6989586621679599043"><span class="hs-identifier hs-var">outputHandle</span></a></span></span><span> </span><span id="local-6989586621679599042"><span class="annot"><span class="annottext">onError :: ErrorOutput
</span><a href="#local-6989586621679599042"><span class="hs-identifier hs-var">onError</span></a></span></span><span> </span><span id="local-6989586621679599041"><span class="annot"><span class="annottext">terminateOnError :: TerminateOnError
</span><a href="#local-6989586621679599041"><span class="hs-identifier hs-var">terminateOnError</span></a></span></span><span> </span><span id="local-6989586621679599040"><span class="annot"><span class="annottext">sheetName :: Maybe SheetName
</span><a href="#local-6989586621679599040"><span class="hs-identifier hs-var">sheetName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>  </span><span id="local-6989586621679599039"><span class="annot"><span class="annottext">Maybe ([Value], [Value])
</span><a href="#local-6989586621679599039"><span class="hs-identifier hs-var">headerRowsMaybe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe Text -&gt; m (Maybe ([Value], [Value]))
forall (m :: * -&gt; *).
MonadIO m =&gt;
FilePath -&gt; Maybe Text -&gt; m (Maybe ([Value], [Value]))
</span><a href="Parse.Xlsx.html#readXlsxFile"><span class="hs-identifier hs-var">readXlsxFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599044"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SheetName -&gt; Text) -&gt; Maybe SheetName -&gt; Maybe Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SheetName -&gt; Text
</span><a href="Runtime.Types.html#unSheetName"><span class="hs-identifier hs-var hs-var">unSheetName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SheetName
</span><a href="#local-6989586621679599040"><span class="hs-identifier hs-var">sheetName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ([Value], [Value])
</span><a href="#local-6989586621679599039"><span class="hs-identifier hs-var">headerRowsMaybe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679599037"><span class="annot"><span class="annottext">h :: [Value]
</span><a href="#local-6989586621679599037"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679599036"><span class="annot"><span class="annottext">rows :: [Value]
</span><a href="#local-6989586621679599036"><span class="hs-identifier hs-var">rows</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="annottext">Value
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b.
(MonadMask m, MonadReader JSContextPtr m, MonadIO m, ToJSON a) =&gt;
a -&gt; (JSValue -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withJSValue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Value] -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679599037"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((JSValue -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599035"><span class="annot"><span class="annottext">header :: JSValue
</span><a href="#local-6989586621679599035"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><span class="annottext">[Value]
-&gt; (Int -&gt; Value -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (f :: * -&gt; *) (m :: * -&gt; *) row.
(FoldableWithIndex Int f, MonadThrow m) =&gt;
f row
-&gt; (Int -&gt; row -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processRow"><span class="hs-identifier hs-var">processRow</span></a></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679599036"><span class="hs-identifier hs-var">rows</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Value -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (Int -&gt; Value -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599034"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679599034"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679599033"><span class="annot"><span class="annottext">rowJSON :: Value
</span><a href="#local-6989586621679599033"><span class="hs-identifier hs-var">rowJSON</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-210"></span><span>          </span><span class="annot"><span class="annottext">Int
-&gt; Value
-&gt; JSValue
-&gt; (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) header.
(MonadReader JSContextPtr m, MonadMask m, MonadIO m) =&gt;
Int
-&gt; Value
-&gt; header
-&gt; (JSValue -&gt; header -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#convertRow"><span class="hs-identifier hs-var">convertRow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599034"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599033"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue
</span><a href="#local-6989586621679599035"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599046"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599045"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679599043"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679599042"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679599041"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SheetName
</span><a href="#local-6989586621679599040"><span class="hs-identifier hs-var">sheetName</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-212"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Runtime.Types.html#SheetName"><span class="hs-identifier hs-type">SheetName</span></a></span><span> </span><span id="local-6989586621679599031"><span class="annot"><span class="annottext">s :: Text
</span><a href="#local-6989586621679599031"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SheetNotFound -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(SheetNotFound -&gt; m (HashMap Value (HashSet Value)))
-&gt; SheetNotFound -&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SheetNotFound
</span><a href="Runtime.Error.html#SheetNotFound"><span class="hs-identifier hs-var">SheetNotFound</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679599031"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-213"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuntimeError -&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; m (HashMap Value (HashSet Value)))
-&gt; RuntimeError -&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; RuntimeError
</span><a href="Runtime.Error.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; RuntimeError) -&gt; FilePath -&gt; RuntimeError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;No sheets found in file.&quot;</span></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span id="local-6989586621679599194"><span class="annot"><a href="Runtime.html#processCsvFile"><span class="hs-identifier hs-type">processCsvFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679599194"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679599194"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679599194"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-218"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599194"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ValidatorFailure</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutput"><span class="hs-identifier hs-type">DataOutput</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-type">ErrorOutput</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier hs-type">TerminateOnError</span></a></span><span> </span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599194"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-225"></span><span id="processCsvFile"><span class="annot"><span class="annottext">processCsvFile :: (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processCsvFile"><span class="hs-identifier hs-var hs-var">processCsvFile</span></a></span></span><span> </span><span id="local-6989586621679599027"><span class="annot"><span class="annottext">rowFun :: JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599027"><span class="hs-identifier hs-var">rowFun</span></a></span></span><span> </span><span id="local-6989586621679599026"><span class="annot"><span class="annottext">validator :: Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599026"><span class="hs-identifier hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621679599025"><span class="annot"><span class="annottext">fName :: FilePath
</span><a href="#local-6989586621679599025"><span class="hs-identifier hs-var">fName</span></a></span></span><span> </span><span id="local-6989586621679599024"><span class="annot"><span class="annottext">outputHandle :: DataOutput
</span><a href="#local-6989586621679599024"><span class="hs-identifier hs-var">outputHandle</span></a></span></span><span> </span><span id="local-6989586621679599023"><span class="annot"><span class="annottext">onError :: ErrorOutput
</span><a href="#local-6989586621679599023"><span class="hs-identifier hs-var">onError</span></a></span></span><span> </span><span id="local-6989586621679599022"><span class="annot"><span class="annottext">terminateOnError :: TerminateOnError
</span><a href="#local-6989586621679599022"><span class="hs-identifier hs-var">terminateOnError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679599021"><span class="annot"><span class="annottext">h :: [Value]
</span><a href="#local-6989586621679599021"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679599020"><span class="annot"><span class="annottext">rows :: Records Object
</span><a href="#local-6989586621679599020"><span class="hs-identifier hs-var">rows</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; m ([Value], Records Object)
forall (m :: * -&gt; *).
(MonadThrow m, MonadIO m) =&gt;
FilePath -&gt; m ([Value], Records Object)
</span><a href="Parse.Csv.html#readCsvFile"><span class="hs-identifier hs-var">readCsvFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599025"><span class="hs-identifier hs-var">fName</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><span class="annottext">[Value]
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b.
(MonadMask m, MonadReader JSContextPtr m, MonadIO m, ToJSON a) =&gt;
a -&gt; (JSValue -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withJSValue</span></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679599021"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">((JSValue -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599019"><span class="annot"><span class="annottext">header :: JSValue
</span><a href="#local-6989586621679599019"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">Records Object
-&gt; (Int -&gt; Object -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (f :: * -&gt; *) (m :: * -&gt; *) row.
(FoldableWithIndex Int f, MonadThrow m) =&gt;
f row
-&gt; (Int -&gt; row -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processRow"><span class="hs-identifier hs-var">processRow</span></a></span><span> </span><span class="annot"><span class="annottext">Records Object
</span><a href="#local-6989586621679599020"><span class="hs-identifier hs-var">rows</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Object -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (Int -&gt; Object -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679599018"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679599018"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679599017"><span class="annot"><span class="annottext">r :: Object
</span><a href="#local-6989586621679599017"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-229"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679599016"><span class="annot"><span class="annottext">rowJSON :: Value
</span><a href="#local-6989586621679599016"><span class="hs-identifier hs-var hs-var">rowJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Object</span></span><span> </span><span class="annot"><span class="annottext">(Object -&gt; Value) -&gt; Object -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; Object -&gt; Object
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599018"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679599017"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span>
</span><span id="line-230"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; Value
-&gt; JSValue
-&gt; (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) header.
(MonadReader JSContextPtr m, MonadMask m, MonadIO m) =&gt;
Int
-&gt; Value
-&gt; header
-&gt; (JSValue -&gt; header -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#convertRow"><span class="hs-identifier hs-var">convertRow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679599018"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679599016"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue
</span><a href="#local-6989586621679599019"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599027"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599026"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679599024"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679599023"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679599022"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span id="local-6989586621679599014"><span class="annot"><a href="Runtime.html#processJsonFile"><span class="hs-identifier hs-type">processJsonFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679599014"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679599014"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679599014"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-234"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599014"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ValidatorFailure</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutput"><span class="hs-identifier hs-type">DataOutput</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-type">ErrorOutput</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier hs-type">TerminateOnError</span></a></span><span> </span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679599014"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-241"></span><span id="processJsonFile"><span class="annot"><span class="annottext">processJsonFile :: (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processJsonFile"><span class="hs-identifier hs-var hs-var">processJsonFile</span></a></span></span><span> </span><span id="local-6989586621679599012"><span class="annot"><span class="annottext">rowFun :: JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599012"><span class="hs-identifier hs-var">rowFun</span></a></span></span><span> </span><span id="local-6989586621679599011"><span class="annot"><span class="annottext">validator :: Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599011"><span class="hs-identifier hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621679599010"><span class="annot"><span class="annottext">fName :: FilePath
</span><a href="#local-6989586621679599010"><span class="hs-identifier hs-var">fName</span></a></span></span><span> </span><span id="local-6989586621679599009"><span class="annot"><span class="annottext">outputHandle :: DataOutput
</span><a href="#local-6989586621679599009"><span class="hs-identifier hs-var">outputHandle</span></a></span></span><span> </span><span id="local-6989586621679599008"><span class="annot"><span class="annottext">onError :: ErrorOutput
</span><a href="#local-6989586621679599008"><span class="hs-identifier hs-var">onError</span></a></span></span><span> </span><span id="local-6989586621679599007"><span class="annot"><span class="annottext">terminateOnError :: TerminateOnError
</span><a href="#local-6989586621679599007"><span class="hs-identifier hs-var">terminateOnError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621679599006"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599006"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; m ByteString
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; m ByteString) -&gt; IO ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BSL.readFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679599010"><span class="hs-identifier hs-var">fName</span></a></span><span class="hs-special">;</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679599004"><span class="annot"><span class="annottext">rows :: [Value]
</span><a href="#local-6989586621679599004"><span class="hs-identifier hs-var">rows</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679599003"><span class="annot"><span class="annottext">hs :: [Text]
</span><a href="#local-6989586621679599003"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe Value
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">decode</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679599006"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Array</span></span><span> </span><span id="local-6989586621679599002"><span class="annot"><span class="annottext">js :: Array
</span><a href="#local-6989586621679599002"><span class="hs-identifier hs-var">js</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array -&gt; [Value]
forall a. Vector a -&gt; [a]
</span><span class="hs-identifier hs-var">V.toList</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679599002"><span class="hs-identifier hs-var">js</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet Text -&gt; [Text]
forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(HashSet Text -&gt; [Text]) -&gt; HashSet Text -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HashSet Text -&gt; Value -&gt; HashSet Text)
-&gt; HashSet Text -&gt; Array -&gt; HashSet Text
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Vector b -&gt; a
</span><span class="hs-identifier hs-var">V.foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679598998"><span class="annot"><span class="annottext">acc :: HashSet Text
</span><a href="#local-6989586621679598998"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679598997"><span class="annot"><span class="annottext">o :: Value
</span><a href="#local-6989586621679598997"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Text] -&gt; HashSet Text
forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; HashSet Text) -&gt; [Text] -&gt; HashSet Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [Text]
</span><a href="#local-6989586621679598995"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598997"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet Text -&gt; HashSet Text -&gt; HashSet Text
forall a. (Eq a, Hashable a) =&gt; HashSet a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-operator hs-var">`S.union`</span></span><span> </span><span class="annot"><span class="annottext">HashSet Text
</span><a href="#local-6989586621679598998"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet Text
forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679599002"><span class="hs-identifier hs-var">js</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679598993"><span class="annot"><span class="annottext">o :: Value
</span><a href="#local-6989586621679598993"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598993"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Value -&gt; [Text]
</span><a href="#local-6989586621679598995"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598993"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>  </span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><span class="annottext">Value
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) a b.
(MonadMask m, MonadReader JSContextPtr m, MonadIO m, ToJSON a) =&gt;
a -&gt; (JSValue -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withJSValue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Object</span></span><span> </span><span class="annot"><span class="annottext">(Object -&gt; Value) -&gt; Object -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Text, Value)] -&gt; Object
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Text, Value)] -&gt; Object) -&gt; [(Text, Value)] -&gt; Object
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; (Text, Value)) -&gt; [Text] -&gt; [(Text, Value)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679598992"><span class="annot"><span class="annottext">h :: Text
</span><a href="#local-6989586621679598992"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;h&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679598992"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679599003"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((JSValue -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (JSValue -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679598991"><span class="annot"><span class="annottext">header :: JSValue
</span><a href="#local-6989586621679598991"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">[Value]
-&gt; (Int -&gt; Value -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall (f :: * -&gt; *) (m :: * -&gt; *) row.
(FoldableWithIndex Int f, MonadThrow m) =&gt;
f row
-&gt; (Int -&gt; row -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processRow"><span class="hs-identifier hs-var">processRow</span></a></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679599004"><span class="hs-identifier hs-var">rows</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Value -&gt; m (HashMap Value (HashSet Value)))
 -&gt; m (HashMap Value (HashSet Value)))
-&gt; (Int -&gt; Value -&gt; m (HashMap Value (HashSet Value)))
-&gt; m (HashMap Value (HashSet Value))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679598990"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679598990"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679598989"><span class="annot"><span class="annottext">r :: Value
</span><a href="#local-6989586621679598989"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679598988"><span class="annot"><span class="annottext">rowJSON :: Value
</span><a href="#local-6989586621679598988"><span class="hs-identifier hs-var hs-var">rowJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Value -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value -&gt; Value
</span><a href="#local-6989586621679598987"><span class="hs-identifier hs-var">insertI</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679598990"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598989"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Value
-&gt; JSValue
-&gt; (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *) header.
(MonadReader JSContextPtr m, MonadMask m, MonadIO m) =&gt;
Int
-&gt; Value
-&gt; header
-&gt; (JSValue -&gt; header -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#convertRow"><span class="hs-identifier hs-var">convertRow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679598990"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598988"><span class="hs-identifier hs-var">rowJSON</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue
</span><a href="#local-6989586621679598991"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679599012"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679599011"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679599009"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679599008"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679599007"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span>
</span><span id="line-252"></span><span>   </span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621679598995"><span class="annot"><span class="annottext">getHeader :: Value -&gt; [Text]
</span><a href="#local-6989586621679598995"><span class="hs-identifier hs-var hs-var">getHeader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Object</span></span><span> </span><span id="local-6989586621679598986"><span class="annot"><span class="annottext">o :: Object
</span><a href="#local-6989586621679598986"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Object -&gt; [Text]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">HM.keys</span></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679598986"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><a href="#local-6989586621679598995"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621679598987"><span class="annot"><span class="annottext">insertI :: a -&gt; Value -&gt; Value
</span><a href="#local-6989586621679598987"><span class="hs-identifier hs-var hs-var">insertI</span></a></span></span><span> </span><span id="local-6989586621679598984"><span class="annot"><span class="annottext">i :: a
</span><a href="#local-6989586621679598984"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Object</span></span><span> </span><span id="local-6989586621679598983"><span class="annot"><span class="annottext">o :: Object
</span><a href="#local-6989586621679598983"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Object</span></span><span> </span><span class="annot"><span class="annottext">(Object -&gt; Value) -&gt; Object -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; Object -&gt; Object
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679598984"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679598983"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><a href="#local-6989586621679598987"><span class="hs-identifier hs-var">insertI</span></a></span><span> </span><span id="local-6989586621679598982"><span class="annot"><span class="annottext">i :: a
</span><a href="#local-6989586621679598982"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679598981"><span class="annot"><span class="annottext">o :: Value
</span><a href="#local-6989586621679598981"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Object -&gt; Value
</span><span class="hs-identifier hs-var">Object</span></span><span> </span><span class="annot"><span class="annottext">(Object -&gt; Value) -&gt; Object -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Text, Value)] -&gt; Object
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;i&quot;</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">a -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679598982"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;data&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598981"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span id="local-6989586621679598980"><span class="annot"><a href="Runtime.html#processFile"><span class="hs-identifier hs-type">processFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679598980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679598980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSContextPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679598980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-265"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">JSValue</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679598980"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Function taking the row and header `JSValue`s, returning a JSON 'Value'</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ValidatorFailure</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Validator function, used to check that the output of the converter function</span><span>
</span><span id="line-267"></span><span>                                   </span><span class="hs-comment">-- conforms to the JSON schema, specified in 'jsonSchema'</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-comment">-- ^ Path of the input file</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#FileType"><span class="hs-identifier hs-type">FileType</span></a></span><span>  </span><span class="hs-comment">-- ^ Number of rows to skip/row number to start from only used when 'FileType' is 'TXTFile'. Default is 0.</span><span>
</span><span id="line-270"></span><span>                                           </span><span class="hs-comment">-- Optional sheet name only used when 'FileType' is 'XLSXFile'.</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#DataOutputOpt"><span class="hs-identifier hs-type">DataOutputOpt</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#ErrorOpt"><span class="hs-identifier hs-type">ErrorOpt</span></a></span><span> </span><span class="hs-comment">-- ^ Describes the error behaviour when parsing a row of the input. </span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Runtime.Types.html#TerminateOnError"><span class="hs-identifier hs-type">TerminateOnError</span></a></span><span> </span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679598980"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-275"></span><span id="processFile"><span class="annot"><span class="annottext">processFile :: (JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; FileType
-&gt; DataOutputOpt
-&gt; ErrorOpt
-&gt; TerminateOnError
-&gt; m ()
</span><a href="Runtime.html#processFile"><span class="hs-identifier hs-var hs-var">processFile</span></a></span></span><span> </span><span id="local-6989586621679598979"><span class="annot"><span class="annottext">rowFun :: JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679598979"><span class="hs-identifier hs-var">rowFun</span></a></span></span><span> </span><span id="local-6989586621679598978"><span class="annot"><span class="annottext">validator :: Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679598978"><span class="hs-identifier hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621679598977"><span class="annot"><span class="annottext">fName :: FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span></span><span> </span><span id="local-6989586621679598976"><span class="annot"><span class="annottext">fType :: FileType
</span><a href="#local-6989586621679598976"><span class="hs-identifier hs-var">fType</span></a></span></span><span> </span><span id="local-6989586621679598975"><span class="annot"><span class="annottext">outOpt :: DataOutputOpt
</span><a href="#local-6989586621679598975"><span class="hs-identifier hs-var">outOpt</span></a></span></span><span> </span><span id="local-6989586621679598974"><span class="annot"><span class="annottext">onError :: ErrorOpt
</span><a href="#local-6989586621679598974"><span class="hs-identifier hs-var">onError</span></a></span></span><span> </span><span id="local-6989586621679598973"><span class="annot"><span class="annottext">terminateOnError :: TerminateOnError
</span><a href="#local-6989586621679598973"><span class="hs-identifier hs-var">terminateOnError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DataOutputOpt
</span><a href="#local-6989586621679598975"><span class="hs-identifier hs-var">outOpt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">-- if we have db conn info, we will be writing into the db instead of a file</span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><a href="Runtime.Types.html#DBOutputOpt"><span class="hs-identifier hs-type">DBOutputOpt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="DB.html#SomeDBType"><span class="hs-identifier hs-type">SomeDBType</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679598970"><span id="local-6989586621679598969"><span class="annot"><span class="annottext">DBType con_ty
</span><a href="#local-6989586621679598969"><span class="hs-identifier hs-var">db_type</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="DB.html#DBType"><span class="hs-identifier hs-type">DBType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679598970"><span class="hs-identifier hs-type">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598968"><span class="annot"><span class="annottext">user :: User
</span><a href="#local-6989586621679598968"><span class="hs-identifier hs-var">user</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598967"><span class="annot"><span class="annottext">pass :: Password
</span><a href="#local-6989586621679598967"><span class="hs-identifier hs-var">pass</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598966"><span class="annot"><span class="annottext">host :: Host
</span><a href="#local-6989586621679598966"><span class="hs-identifier hs-var">host</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598965"><span class="annot"><span class="annottext">port :: Port
</span><a href="#local-6989586621679598965"><span class="hs-identifier hs-var">port</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598964"><span class="annot"><span class="annottext">db :: Database
</span><a href="#local-6989586621679598964"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679598963"><span class="annot"><span class="annottext">sourceID :: SourceID
</span><a href="#local-6989586621679598963"><span class="hs-identifier hs-var">sourceID</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-279"></span><span>      </span><span class="annot"><span class="annottext">m (con_ty, Maybe Handle)
-&gt; ((con_ty, Maybe Handle) -&gt; m (Maybe ()))
-&gt; ((con_ty, Maybe Handle) -&gt; m ())
-&gt; m ()
forall (m :: * -&gt; *) a c b.
MonadMask m =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-comment">-- open a connection to the db</span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (con_ty, Maybe Handle) -&gt; m (con_ty, Maybe Handle)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (con_ty, Maybe Handle) -&gt; m (con_ty, Maybe Handle))
-&gt; IO (con_ty, Maybe Handle) -&gt; m (con_ty, Maybe Handle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>          </span><span id="local-6989586621679598962"><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598962"><span class="hs-identifier hs-var">dbHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">User -&gt; Password -&gt; Host -&gt; Port -&gt; Database -&gt; IO con_ty
forall con_ty.
DBConn con_ty =&gt;
User -&gt; Password -&gt; Host -&gt; Port -&gt; Database -&gt; IO con_ty
</span><a href="DB.html#connect"><span class="hs-identifier hs-var">DB.connect</span></a></span><span> </span><span class="annot"><span class="annottext">User
</span><a href="#local-6989586621679598968"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Password
</span><a href="#local-6989586621679598967"><span class="hs-identifier hs-var">pass</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621679598966"><span class="hs-identifier hs-var">host</span></a></span><span> </span><span class="annot"><span class="annottext">Port
</span><a href="#local-6989586621679598965"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">Database
</span><a href="#local-6989586621679598964"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-283"></span><span>          </span><span id="local-6989586621679598960"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598960"><span class="hs-identifier hs-var">logHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="#local-6989586621679598974"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOpt -&gt; ErrorOpt -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="Runtime.Types.html#LogToFile"><span class="hs-identifier hs-var">LogToFile</span></a></span><span> </span><span>
</span><span id="line-284"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;log&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Maybe Handle) -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Maybe Handle
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; Maybe Handle) -&gt; IO Handle -&gt; IO (Maybe Handle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;log&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span> </span><span>
</span><span id="line-285"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Handle -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-286"></span><span>          </span><span class="annot"><span class="annottext">(con_ty, Maybe Handle) -&gt; IO (con_ty, Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598962"><span class="hs-identifier hs-var">dbHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598960"><span class="hs-identifier hs-var">logHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-comment">-- this action runs after completing the main body function</span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679598955"><span class="annot"><span class="annottext">dbHandle :: con_ty
</span><a href="#local-6989586621679598955"><span class="hs-identifier hs-var">dbHandle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598954"><span class="annot"><span class="annottext">logFileHandle :: Maybe Handle
</span><a href="#local-6989586621679598954"><span class="hs-identifier hs-var">logFileHandle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">con_ty -&gt; IO ()
forall con_ty. DBConn con_ty =&gt; con_ty -&gt; IO ()
</span><a href="DB.html#disconnect"><span class="hs-identifier hs-var">DB.disconnect</span></a></span><span> </span><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598955"><span class="hs-identifier hs-var">dbHandle</span></a></span><span>
</span><span id="line-291"></span><span>          </span><span class="annot"><span class="annottext">IO (Maybe ()) -&gt; m (Maybe ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ()) -&gt; m (Maybe ())) -&gt; IO (Maybe ()) -&gt; m (Maybe ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; IO ()) -&gt; Maybe Handle -&gt; IO (Maybe ())
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598954"><span class="hs-identifier hs-var">logFileHandle</span></a></span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((con_ty, Maybe Handle) -&gt; m ()) -&gt; m ())
-&gt; ((con_ty, Maybe Handle) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-293"></span><span>        </span><span class="hs-comment">-- main body function</span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679598951"><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598951"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679598970"><span class="hs-identifier hs-type">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598950"><span class="annot"><span class="annottext">logFileHandle :: Maybe Handle
</span><a href="#local-6989586621679598950"><span class="hs-identifier hs-var">logFileHandle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-295"></span><span>          </span><span id="local-6989586621679598949"><span class="annot"><span class="annottext">FileID
</span><a href="#local-6989586621679598949"><span class="hs-identifier hs-var">fileID</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">IO FileID -&gt; m FileID
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO FileID -&gt; m FileID) -&gt; IO FileID -&gt; m FileID
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceID -&gt; FilePath -&gt; con_ty -&gt; IO (Maybe FileID)
forall con.
DBConn con =&gt;
SourceID -&gt; FilePath -&gt; con -&gt; IO (Maybe FileID)
</span><a href="DB.html#getFileID"><span class="hs-identifier hs-var">getFileID</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679598963"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath
</span><span class="hs-identifier hs-var">takeFileName</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598951"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe FileID) -&gt; (Maybe FileID -&gt; IO FileID) -&gt; IO FileID
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-297"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679598947"><span class="annot"><span class="annottext">fileID :: FileID
</span><a href="#local-6989586621679598947"><span class="hs-identifier hs-var">fileID</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>                </span><span class="hs-comment">-- clear any errors from a possible previous run, if we are logging to db</span><span>
</span><span id="line-299"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceID -&gt; FileID -&gt; con_ty -&gt; IO ()
forall con. DBConn con =&gt; SourceID -&gt; FileID -&gt; con -&gt; IO ()
</span><a href="DB.html#clearErrors"><span class="hs-identifier hs-var">clearErrors</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679598963"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="annot"><span class="annottext">FileID
</span><a href="#local-6989586621679598947"><span class="hs-identifier hs-var">fileID</span></a></span><span> </span><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598951"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-300"></span><span>                </span><span class="annot"><span class="annottext">FileID -&gt; IO FileID
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">FileID
</span><a href="#local-6989586621679598947"><span class="hs-identifier hs-var">fileID</span></a></span><span>
</span><span id="line-301"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FileIDNotFound -&gt; IO FileID
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(FileIDNotFound -&gt; IO FileID) -&gt; FileIDNotFound -&gt; IO FileID
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FileIDNotFound
</span><a href="Runtime.Error.html#FileIDNotFound"><span class="hs-identifier hs-var">FileIDNotFound</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span>
</span><span id="line-302"></span><span>          </span><span id="local-6989586621679598944"><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679598944"><span class="hs-identifier hs-var">jsonAttrVals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataOutput -&gt; ErrorOutput -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679598943"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">DBOutput :: forall con_t.
DBConn con_t =&gt;
con_t -&gt; SourceID -&gt; FileID -&gt; DataOutput
</span><a href="Runtime.Types.html#DBOutput"><span class="hs-identifier hs-type hs-type">DBOutput</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataOutput -&gt; ErrorOutput
</span><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-var">ErrorOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(DataOutput -&gt; ErrorOutput) -&gt; DataOutput -&gt; ErrorOutput
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="#local-6989586621679598974"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOpt -&gt; ErrorOpt -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="Runtime.Types.html#LogToConsole"><span class="hs-identifier hs-var">LogToConsole</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="Runtime.Types.html#ConsoleOutput"><span class="hs-identifier hs-var">ConsoleOutput</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DataOutput -&gt; Maybe DataOutput -&gt; DataOutput
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">DBOutput :: forall con_t.
DBConn con_t =&gt;
con_t -&gt; SourceID -&gt; FileID -&gt; DataOutput
</span><a href="Runtime.Types.html#DBOutput"><span class="hs-identifier hs-type hs-type">DBOutput</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle -&gt; DataOutput
</span><a href="Runtime.Types.html#JSONFileOutput"><span class="hs-identifier hs-var">JSONFileOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; DataOutput) -&gt; Maybe Handle -&gt; Maybe DataOutput
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598950"><span class="hs-identifier hs-var">logFileHandle</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DBType con_ty
</span><a href="#local-6989586621679598969"><span class="hs-identifier hs-var">db_type</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-304"></span><span>            </span><span class="annot"><a href="DB.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-305"></span><span>              </span><span class="annot"><span class="annottext">[(Value, HashSet Value)]
-&gt; ((Value, HashSet Value) -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap Value (HashSet Value) -&gt; [(Value, HashSet Value)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">HM.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap Value (HashSet Value)
</span><a href="#local-6989586621679598944"><span class="hs-identifier hs-var">jsonAttrVals</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Value, HashSet Value) -&gt; IO ()) -&gt; IO ())
-&gt; ((Value, HashSet Value) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679598935"><span class="annot"><span class="annottext">attr :: Value
</span><a href="#local-6989586621679598935"><span class="hs-identifier hs-var">attr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679598934"><span class="annot"><span class="annottext">vs :: HashSet Value
</span><a href="#local-6989586621679598934"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-306"></span><span>                </span><span class="annot"><span class="annottext">SourceID -&gt; Value -&gt; Value -&gt; con_ty -&gt; IO ()
forall conn.
IConnection conn =&gt;
SourceID -&gt; Value -&gt; Value -&gt; conn -&gt; IO ()
</span><a href="DB.Postgres.html#insertJSONBAttributesValuesMergeOnConflict"><span class="hs-identifier hs-var">Postgres.insertJSONBAttributesValuesMergeOnConflict</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679598963"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679598935"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet Value -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">HashSet Value
</span><a href="#local-6989586621679598934"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598951"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-307"></span><span>              </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">con_ty -&gt; IO (Maybe Int)
forall conn. IConnection conn =&gt; conn -&gt; IO (Maybe Int)
</span><a href="DB.Postgres.html#cleanupJSONBAttributesValues"><span class="hs-identifier hs-var">Postgres.cleanupJSONBAttributesValues</span></a></span><span> </span><span class="annot"><span class="annottext">con_ty
</span><a href="#local-6989586621679598951"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-308"></span><span>              </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><a href="Runtime.Types.html#JSONFileOutputOpt"><span class="hs-identifier hs-type">JSONFileOutputOpt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="annottext">m (Handle, Maybe Handle)
-&gt; ((Handle, Maybe Handle) -&gt; m (Maybe ()))
-&gt; ((Handle, Maybe Handle) -&gt; m ())
-&gt; m ()
forall (m :: * -&gt; *) a c b.
MonadMask m =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-comment">-- open an output file and write an opening bracket '['</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Handle, Maybe Handle) -&gt; m (Handle, Maybe Handle)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Handle, Maybe Handle) -&gt; m (Handle, Maybe Handle))
-&gt; IO (Handle, Maybe Handle) -&gt; m (Handle, Maybe Handle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-314"></span><span>          </span><span id="local-6989586621679598930"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598930"><span class="hs-identifier hs-var">outHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;out.json&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;[\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Handle -&gt; IO Handle
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;out.json&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span>
</span><span id="line-315"></span><span>          </span><span id="local-6989586621679598929"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598929"><span class="hs-identifier hs-var">logHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="#local-6989586621679598974"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOpt -&gt; ErrorOpt -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="Runtime.Types.html#LogToFile"><span class="hs-identifier hs-var">LogToFile</span></a></span><span> </span><span>
</span><span id="line-316"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;log&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Maybe Handle) -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Maybe Handle
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; Maybe Handle) -&gt; IO Handle -&gt; IO (Maybe Handle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;log&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span> </span><span>
</span><span id="line-317"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Handle -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">(Handle, Maybe Handle) -&gt; IO (Handle, Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598930"><span class="hs-identifier hs-var">outHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598929"><span class="hs-identifier hs-var">logHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-comment">-- after the main body, write closing bracket ']' and close the file</span><span>
</span><span id="line-321"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679598928"><span class="annot"><span class="annottext">outputFileHandle :: Handle
</span><a href="#local-6989586621679598928"><span class="hs-identifier hs-var">outputFileHandle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598927"><span class="annot"><span class="annottext">logFileHandle :: Maybe Handle
</span><a href="#local-6989586621679598927"><span class="hs-identifier hs-var">logFileHandle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BSL.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598928"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;\n]&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598928"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span>
</span><span id="line-323"></span><span>          </span><span class="annot"><span class="annottext">IO (Maybe ()) -&gt; m (Maybe ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ()) -&gt; m (Maybe ())) -&gt; IO (Maybe ()) -&gt; m (Maybe ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; IO ()) -&gt; Maybe Handle -&gt; IO (Maybe ())
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598927"><span class="hs-identifier hs-var">logFileHandle</span></a></span><span>
</span><span id="line-324"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Handle, Maybe Handle) -&gt; m ()) -&gt; m ())
-&gt; ((Handle, Maybe Handle) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-325"></span><span>        </span><span class="hs-comment">-- main body</span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679598926"><span class="annot"><span class="annottext">outputFileHandle :: Handle
</span><a href="#local-6989586621679598926"><span class="hs-identifier hs-var">outputFileHandle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598925"><span class="annot"><span class="annottext">logFileHandle :: Maybe Handle
</span><a href="#local-6989586621679598925"><span class="hs-identifier hs-var">logFileHandle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>          </span><span class="annot"><span class="annottext">DataOutput -&gt; ErrorOutput -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679598943"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle -&gt; DataOutput
</span><a href="Runtime.Types.html#JSONFileOutput"><span class="hs-identifier hs-var">JSONFileOutput</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598926"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataOutput -&gt; ErrorOutput
</span><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-var">ErrorOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(DataOutput -&gt; ErrorOutput) -&gt; DataOutput -&gt; ErrorOutput
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DataOutput -&gt; Maybe DataOutput -&gt; DataOutput
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="Runtime.Types.html#ConsoleOutput"><span class="hs-identifier hs-var">ConsoleOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe DataOutput -&gt; DataOutput) -&gt; Maybe DataOutput -&gt; DataOutput
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; DataOutput
</span><a href="Runtime.Types.html#JSONFileOutput"><span class="hs-identifier hs-var">JSONFileOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; DataOutput) -&gt; Maybe Handle -&gt; Maybe DataOutput
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598925"><span class="hs-identifier hs-var">logFileHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (HashMap Value (HashSet Value)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="Runtime.Types.html#SQLFileOutputOpt"><span class="hs-identifier hs-type">SQLFileOutputOpt</span></a></span><span> </span><span id="local-6989586621679598923"><span class="annot"><span class="annottext">sourceID :: SourceID
</span><a href="#local-6989586621679598923"><span class="hs-identifier hs-var">sourceID</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-330"></span><span>      </span><span class="annot"><span class="annottext">m (Handle, Maybe Handle)
-&gt; ((Handle, Maybe Handle) -&gt; m (Maybe ()))
-&gt; ((Handle, Maybe Handle) -&gt; m ())
-&gt; m ()
forall (m :: * -&gt; *) a c b.
MonadMask m =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- open an output file </span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Handle, Maybe Handle) -&gt; m (Handle, Maybe Handle)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Handle, Maybe Handle) -&gt; m (Handle, Maybe Handle))
-&gt; IO (Handle, Maybe Handle) -&gt; m (Handle, Maybe Handle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>          </span><span id="local-6989586621679598922"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598922"><span class="hs-identifier hs-var">outHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;out.sql&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Handle -&gt; IO Handle
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;out.sql&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span>
</span><span id="line-334"></span><span>          </span><span id="local-6989586621679598921"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598921"><span class="hs-identifier hs-var">logHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="#local-6989586621679598974"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOpt -&gt; ErrorOpt -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ErrorOpt
</span><a href="Runtime.Types.html#LogToFile"><span class="hs-identifier hs-var">LogToFile</span></a></span><span> </span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;log&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Maybe Handle) -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Maybe Handle
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; Maybe Handle) -&gt; IO Handle -&gt; IO (Maybe Handle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">openFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;log&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span> </span><span>
</span><span id="line-336"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Handle -&gt; IO (Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-337"></span><span>          </span><span class="annot"><span class="annottext">(Handle, Maybe Handle) -&gt; IO (Handle, Maybe Handle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598922"><span class="hs-identifier hs-var">outHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598921"><span class="hs-identifier hs-var">logHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-comment">-- after the main body, close the file</span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679598920"><span class="annot"><span class="annottext">outputFileHandle :: Handle
</span><a href="#local-6989586621679598920"><span class="hs-identifier hs-var">outputFileHandle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598919"><span class="annot"><span class="annottext">logFileHandle :: Maybe Handle
</span><a href="#local-6989586621679598919"><span class="hs-identifier hs-var">logFileHandle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598920"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span>
</span><span id="line-342"></span><span>          </span><span class="annot"><span class="annottext">IO (Maybe ()) -&gt; m (Maybe ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ()) -&gt; m (Maybe ())) -&gt; IO (Maybe ()) -&gt; m (Maybe ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; IO ()) -&gt; Maybe Handle -&gt; IO (Maybe ())
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598919"><span class="hs-identifier hs-var">logFileHandle</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Handle, Maybe Handle) -&gt; m ()) -&gt; m ())
-&gt; ((Handle, Maybe Handle) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-344"></span><span>        </span><span class="hs-comment">-- main body</span><span>
</span><span id="line-345"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679598918"><span class="annot"><span class="annottext">outputFileHandle :: Handle
</span><a href="#local-6989586621679598918"><span class="hs-identifier hs-var">outputFileHandle</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679598917"><span class="annot"><span class="annottext">logFileHandle :: Maybe Handle
</span><a href="#local-6989586621679598917"><span class="hs-identifier hs-var">logFileHandle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>          </span><span class="annot"><span class="annottext">DataOutput -&gt; ErrorOutput -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679598943"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceID -&gt; Handle -&gt; DataOutput
</span><a href="Runtime.Types.html#SQLFileOutput"><span class="hs-identifier hs-var">SQLFileOutput</span></a></span><span> </span><span class="annot"><span class="annottext">SourceID
</span><a href="#local-6989586621679598923"><span class="hs-identifier hs-var">sourceID</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679598918"><span class="hs-identifier hs-var">outputFileHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataOutput -&gt; ErrorOutput
</span><a href="Runtime.Types.html#ErrorOutput"><span class="hs-identifier hs-var">ErrorOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(DataOutput -&gt; ErrorOutput) -&gt; DataOutput -&gt; ErrorOutput
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DataOutput -&gt; Maybe DataOutput -&gt; DataOutput
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="Runtime.Types.html#ConsoleOutput"><span class="hs-identifier hs-var">ConsoleOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe DataOutput -&gt; DataOutput) -&gt; Maybe DataOutput -&gt; DataOutput
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; DataOutput
</span><a href="Runtime.Types.html#JSONFileOutput"><span class="hs-identifier hs-var">JSONFileOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Handle -&gt; DataOutput) -&gt; Maybe Handle -&gt; Maybe DataOutput
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679598917"><span class="hs-identifier hs-var">logFileHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (HashMap Value (HashSet Value)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span>
</span><span id="line-347"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621679598943"><span class="annot"><span class="annottext">process :: DataOutput -&gt; ErrorOutput -&gt; m (HashMap Value (HashSet Value))
</span><a href="#local-6989586621679598943"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span id="local-6989586621679598916"><span class="annot"><span class="annottext">outputHandle :: DataOutput
</span><a href="#local-6989586621679598916"><span class="hs-identifier hs-var">outputHandle</span></a></span></span><span> </span><span id="local-6989586621679598915"><span class="annot"><span class="annottext">errorHandling :: ErrorOutput
</span><a href="#local-6989586621679598915"><span class="hs-identifier hs-var">errorHandling</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FileType
</span><a href="#local-6989586621679598976"><span class="hs-identifier hs-var">fType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><a href="Runtime.Types.html#TXTFile"><span class="hs-identifier hs-type">TXTFile</span></a></span><span> </span><span id="local-6989586621679598913"><span class="annot"><span class="annottext">startFromLine :: Int
</span><a href="#local-6989586621679598913"><span class="hs-identifier hs-var">startFromLine</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; Int
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *).
(MonadMask m, MonadIO m, MonadReader JSContextPtr m) =&gt;
(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; Int
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processTxtFile"><span class="hs-identifier hs-var">processTxtFile</span></a></span><span>  </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679598979"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679598978"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679598916"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679598915"><span class="hs-identifier hs-var">errorHandling</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679598973"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679598913"><span class="hs-identifier hs-var">startFromLine</span></a></span><span> </span><span>
</span><span id="line-351"></span><span>      </span><span class="annot"><a href="Runtime.Types.html#XLSXFile"><span class="hs-identifier hs-type">XLSXFile</span></a></span><span> </span><span id="local-6989586621679598911"><span class="annot"><span class="annottext">sheetName :: Maybe SheetName
</span><a href="#local-6989586621679598911"><span class="hs-identifier hs-var">sheetName</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; Maybe SheetName
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *).
(MonadMask m, MonadIO m, MonadReader JSContextPtr m) =&gt;
(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; Maybe SheetName
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processXlsxFile"><span class="hs-identifier hs-var">processXlsxFile</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679598979"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679598978"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679598916"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679598915"><span class="hs-identifier hs-var">errorHandling</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679598973"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SheetName
</span><a href="#local-6989586621679598911"><span class="hs-identifier hs-var">sheetName</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><a href="Runtime.Types.html#CSVFile"><span class="hs-identifier hs-type">CSVFile</span></a></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *).
(MonadMask m, MonadIO m, MonadReader JSContextPtr m) =&gt;
(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processCsvFile"><span class="hs-identifier hs-var">processCsvFile</span></a></span><span>  </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679598979"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679598978"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679598916"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679598915"><span class="hs-identifier hs-var">errorHandling</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679598973"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><a href="Runtime.Types.html#JSONFile"><span class="hs-identifier hs-type">JSONFile</span></a></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
forall (m :: * -&gt; *).
(MonadMask m, MonadIO m, MonadReader JSContextPtr m) =&gt;
(JSValue -&gt; JSValue -&gt; m Value)
-&gt; (Value -&gt; [ValidatorFailure])
-&gt; FilePath
-&gt; DataOutput
-&gt; ErrorOutput
-&gt; TerminateOnError
-&gt; m (HashMap Value (HashSet Value))
</span><a href="Runtime.html#processJsonFile"><span class="hs-identifier hs-var">processJsonFile</span></a></span><span> </span><span class="annot"><span class="annottext">JSValue -&gt; JSValue -&gt; m Value
</span><a href="#local-6989586621679598979"><span class="hs-identifier hs-var">rowFun</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; [ValidatorFailure]
</span><a href="#local-6989586621679598978"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679598977"><span class="hs-identifier hs-var">fName</span></a></span><span> </span><span class="annot"><span class="annottext">DataOutput
</span><a href="#local-6989586621679598916"><span class="hs-identifier hs-var">outputHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorOutput
</span><a href="#local-6989586621679598915"><span class="hs-identifier hs-var">errorHandling</span></a></span><span> </span><span class="annot"><span class="annottext">TerminateOnError
</span><a href="#local-6989586621679598973"><span class="hs-identifier hs-var">terminateOnError</span></a></span><span>
</span><span id="line-354"></span></pre></body></html>